import{a as B,r as t,d as c,c as i,j as e,B as o,C as w,b,N as P,Q as R}from"./index-BgzuCSKe.js";import{S as v,a as U,b as D,c as S,d as A}from"./select-DWk-BBhH.js";import{D as H,d as I,a as L,b as M,c as Q}from"./dialog-AKCUCdMT.js";import{U as Y}from"./upload-_QSc8TW1.js";import{T as q}from"./trash-2-nf0tJxYl.js";import{D as z}from"./download-BdUvxDmi.js";import"./index-BZrFsnjO.js";function se(){const{user:n,isAdmin:l}=B(),[f,d]=t.useState([]),[_,k]=t.useState([]),[T,$]=t.useState([]),[E,x]=t.useState(!1),[m,h]=t.useState(""),[u,p]=t.useState(""),[j,g]=t.useState(null),[C,N]=t.useState(!1);t.useEffect(()=>{n&&(y(l),l&&F())},[n,l]);const F=async()=>{try{const[s,a]=await Promise.all([c("/courses"),c("/users")]);k(Array.isArray(s)?s:[]),$(Array.isArray(a)?a:[])}catch(s){console.error(s)}},y=async s=>{if(n)try{const a=await c(`/certificates${s?"?all=1":""}`);d(Array.isArray(a)?a:[])}catch(a){console.error(a),i.error("Failed to load certificates"),d([])}},O=async()=>{if(!m||!u||!j){i.error("Select user, course, and a file");return}N(!0);try{const s=`CERT-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`,a=new FormData;a.append("user_id",u),a.append("course_id",m),a.append("certificate_number",s),a.append("file",j),await c("/certificates",{method:"POST",body:a}),i.success("Certificate uploaded"),x(!1),h(""),p(""),g(null),y(l)}catch(s){i.error((s==null?void 0:s.message)||"Upload failed")}finally{N(!1)}},V=async s=>{try{await c(`/certificates/${s}`,{method:"DELETE"}),d(a=>a.filter(r=>r.id!==s)),i.success("Certificate deleted")}catch(a){i.error((a==null?void 0:a.message)||"Delete failed")}};return e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Certificates"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"View and download your course completion certificates"})]}),l&&e.jsxs(H,{open:E,onOpenChange:x,children:[e.jsx(I,{asChild:!0,children:e.jsxs(o,{children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),"Upload Certificate"]})}),e.jsxs(L,{children:[e.jsx(M,{children:e.jsx(Q,{children:"Upload Certificate"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Select User"}),e.jsxs(v,{value:u,onValueChange:p,children:[e.jsx(U,{children:e.jsx(D,{placeholder:"Choose a user"})}),e.jsx(S,{children:T.map(s=>e.jsx(A,{value:s.id,children:s.full_name||s.email},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Select Course"}),e.jsxs(v,{value:m,onValueChange:h,children:[e.jsx(U,{children:e.jsx(D,{placeholder:"Choose a course"})}),e.jsx(S,{children:_.map(s=>e.jsx(A,{value:s.id,children:s.title},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Certificate File"}),e.jsx("input",{type:"file",accept:".pdf,.png,.jpg,.jpeg",className:"mt-1 block w-full text-sm text-muted-foreground",onChange:s=>{var a;return g(((a=s.target.files)==null?void 0:a[0])||null)}})]}),e.jsx(o,{onClick:O,className:"w-full",disabled:C,children:C?"Uploading...":"Upload Certificate"})]})]})]})]}),f.length===0?e.jsx(w,{children:e.jsxs(b,{className:"py-12 text-center",children:[e.jsx(P,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Certificates Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Upload a certificate to get started"})]})}):e.jsx("div",{className:"grid gap-6",children:f.map(s=>{const a=R(),r=a&&s.file_url?`${s.file_url}${s.file_url.includes("?")?"&":"?"}token=${a}`:s.file_url;return e.jsx(w,{className:"overflow-hidden",children:e.jsxs(b,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Certificate"}),e.jsx("p",{className:"font-semibold",children:s.certificate_number})]}),e.jsxs("div",{className:"flex gap-2",children:[l&&e.jsxs(o,{variant:"ghost",className:"text-destructive",onClick:()=>V(s.id),children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"Delete"]}),r&&e.jsxs(o,{variant:"outline",onClick:()=>window.open(r,"_blank"),children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Download"]})]})]}),r?e.jsx("div",{className:"border rounded-lg overflow-hidden bg-muted/30 min-h-[400px] flex items-center justify-center",children:r.match(/\.pdf($|\?)/i)?e.jsx("iframe",{src:r,className:"w-full h-[500px] border-0",title:"Certificate file"}):e.jsx("img",{src:r,alt:"Certificate",className:"max-h-[600px] w-full object-contain bg-background"})}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No file attached."})]})},s.id)})})]})}export{se as default};
