import{k as Ie,a as Le,r as l,d as o,j as e,B as r,I as d,Y as Ve,M as I,C as T,l as p,m as ze,c as i}from"./index-BgzuCSKe.js";import{L as m}from"./label-CTTYbNyV.js";import{T as pe}from"./textarea-LixU21-h.js";import{T as Me,a as Be,b as ge,c as je}from"./tabs-DzQTwS6e.js";import{D as L,d as V,a as z,b as M,c as B}from"./dialog-AKCUCdMT.js";import{S as b,a as y,b as C,c as S,d as g}from"./select-DWk-BBhH.js";import{U as fe}from"./upload-_QSc8TW1.js";import{P as G}from"./plus-Bn2ZrHCv.js";import{T as J}from"./trash-2-nf0tJxYl.js";import{C as ve}from"./copy-yeOzg1fM.js";import{C as Ne}from"./circle-check-big-Br5TM0nP.js";import"./index-BZrFsnjO.js";function ss(){const{isEditMode:j}=Ie(),{user:u,isAdmin:f,isTeacher:be}=Le(),v=f||be,[h,k]=l.useState([]),[N,U]=l.useState([]),[ye,Ce]=l.useState(!0),[Se,H]=l.useState(!1),[R,Y]=l.useState(""),[we,q]=l.useState(null),[_,K]=l.useState([]),[D,Ae]=l.useState("all"),[_e,Q]=l.useState(!1),[E,W]=l.useState(""),[O,X]=l.useState(""),[Z,ee]=l.useState(1),[De,se]=l.useState(!1),[P,te]=l.useState(""),[$,ae]=l.useState(""),[w,ie]=l.useState(""),[le,ne]=l.useState(null),re=s=>{if(!s)return null;const t=s.includes("T")?s:s.replace(" ","T"),a=new Date(t);return Number.isNaN(a.getTime())?null:a},Fe=s=>{const t=re(s);if(!t)return null;const a=t.getTime()-Date.now();return Math.max(0,Math.floor(a/(1e3*60*60)))};l.useEffect(()=>{u&&(F(),v&&Te())},[u,v]),l.useEffect(()=>{u&&de()},[u,v]);const Te=async()=>{if(v)try{const s=await o("/users");K(s)}catch(s){console.error(s),K([])}},de=async()=>{if(u)try{const s=await o(`/submissions${v?"":"?mine=true"}`);U(s)}catch(s){console.error("Error fetching submissions:",s),U([])}},A=(s,t)=>N.find(a=>a.assignment_id===s&&a.user_id===(u==null?void 0:u.id)),ke=async s=>{try{await o(`/submissions/${s}`,{method:"DELETE"}),U(N.filter(t=>t.id!==s)),i.success("Submission deleted")}catch{i.error("Failed to delete submission")}},ce=()=>!v||D==="all"?N:N.filter(s=>s.user_id===D),Ue=(s,t)=>N.filter(a=>a.assignment_id===s&&a.user_id===t).length,Ee=async()=>{if(!E||!O){i.error("Please select both assignment and user");return}const s=Number(Z)||1;if(s<=0){i.error("Extra attempts must be greater than zero");return}try{await o(`/assignments/${E}/extra-attempts`,{method:"POST",body:JSON.stringify({user_id:O,extra_attempts:s})}),i.success(`Granted ${s} extra attempt(s)`),Q(!1),W(""),X(""),ee(1)}catch(t){i.error((t==null?void 0:t.message)||"Failed to grant extra attempts")}},Oe=async()=>{if(!P||!$||!w){i.error("Select assignment, user, and deadline");return}try{const s=w.includes("T")?`${w.replace("T"," ")}:00`:w;await o(`/assignments/${P}/deadline`,{method:"POST",body:JSON.stringify({user_id:$,deadline:s})}),i.success("Custom deadline saved"),se(!1),te(""),ae(""),ie(""),F()}catch(s){i.error((s==null?void 0:s.message)||"Failed to set deadline")}},Pe=async()=>{if(!we||!R){i.error("Please select a user and upload a PDF");return}i.info("PDF parsing will be implemented with document parsing API"),H(!1),q(null),Y("")},$e=async(s,t)=>{try{ne(s);const a=new FormData;a.append("file",t);const n=h.find(x=>x.id===s);n!=null&&n.course&&a.append("course_id",n.course),await o(`/assignments/${s}/submit`,{method:"POST",body:a}),i.success("Assignment submitted"),await de()}catch(a){i.error((a==null?void 0:a.message)||"Failed to submit assignment")}finally{ne(null)}},F=async()=>{try{const s=await o("/assignments");k(s)}catch(s){console.error("Error fetching assignments:",s)}finally{Ce(!1)}},c=async(s,t,a)=>{try{await o(`/assignments/${s}`,{method:"PATCH",body:JSON.stringify({[t]:a})}),k(h.map(n=>n.id===s?{...n,[t]:a}:n))}catch{i.error("Failed to update assignment")}},oe=async s=>{try{await o(`/assignments/${s}`,{method:"DELETE"}),k(h.filter(t=>t.id!==s)),i.success("Assignment deleted")}catch{i.error("Failed to delete assignment")}},me=async s=>{try{await o("/assignments",{method:"POST",body:JSON.stringify({title:"New Assignment",course:"Course Name",course_code:"CODE",status:s,points:100,priority:"medium",attempts:2})}),F(),i.success("Assignment added")}catch{i.error("Failed to add assignment")}},ue=async s=>{try{await o("/assignments",{method:"POST",body:JSON.stringify({title:`${s.title} (Copy)`,course:s.course,course_code:s.course_code,due_date:s.due_date,priority:s.priority,hours_left:s.hours_left,points:s.points,description:s.description,status:s.status})}),F(),i.success("Assignment duplicated")}catch{i.error("Failed to duplicate assignment")}},he=h.filter(s=>!A(s.id)),xe=h.filter(s=>!!A(s.id));return ye?e.jsx("div",{className:"animate-fade-in",children:"Loading..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-primary bg-clip-text text-transparent",children:f?"All Submissions":"Assignments"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:f?"View and manage all student submissions":"Track and manage your assignments"})]}),f&&e.jsx("div",{className:"flex gap-2",children:e.jsxs(L,{open:Se,onOpenChange:H,children:[e.jsx(V,{asChild:!0,children:e.jsxs(r,{variant:"outline",className:"border-primary/20",children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Bulk Upload"]})}),e.jsxs(z,{children:[e.jsx(M,{children:e.jsx(B,{children:"Upload Assignments File"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Select User"}),e.jsxs(b,{value:R,onValueChange:Y,children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Choose a user"})}),e.jsx(S,{children:_.map(s=>e.jsx(g,{value:s.id,children:s.full_name||s.email},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Upload File (CSV, Excel, or PDF)"}),e.jsx(d,{type:"file",accept:".pdf,.csv,.xlsx,.xls",onChange:s=>{var t;return q(((t=s.target.files)==null?void 0:t[0])||null)}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Upload a file containing assignment details. The system will extract and create assignments for the selected user."})]}),e.jsxs(r,{onClick:Pe,className:"w-full",children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Parse & Add Assignments"]})]})]})]})})]}),f&&e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(m,{className:"text-sm font-medium",children:"Filter by User:"}),e.jsxs(b,{value:D,onValueChange:Ae,children:[e.jsx(y,{className:"w-full sm:w-[250px]",children:e.jsx(C,{placeholder:"All Users"})}),e.jsxs(S,{children:[e.jsx(g,{value:"all",children:"All Users"}),_.map(s=>e.jsx(g,{value:s.id,children:s.full_name||s.email},s.id))]})]})]}),f?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Submitted Assignments"}),e.jsxs(L,{open:_e,onOpenChange:Q,children:[e.jsx(V,{asChild:!0,children:e.jsxs(r,{variant:"outline",children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"Grant Extra Attempts"]})}),e.jsxs(z,{children:[e.jsx(M,{children:e.jsx(B,{children:"Grant Extra Submission Attempts"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Select Assignment"}),e.jsxs(b,{value:E,onValueChange:W,children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Choose assignment"})}),e.jsx(S,{children:h.map(s=>e.jsx(g,{value:s.id,children:s.title},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Select User"}),e.jsxs(b,{value:O,onValueChange:X,children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Choose user"})}),e.jsx(S,{children:_.map(s=>e.jsx(g,{value:s.id,children:s.full_name||s.email},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Extra Attempts"}),e.jsx(d,{type:"number",min:"1",value:Z,onChange:s=>ee(parseInt(s.target.value)||1),placeholder:"Number of extra attempts"})]}),e.jsx(r,{onClick:Ee,className:"w-full",children:"Grant Attempts"})]})]})]}),e.jsxs(L,{open:De,onOpenChange:se,children:[e.jsx(V,{asChild:!0,children:e.jsxs(r,{variant:"outline",children:[e.jsx(I,{className:"h-4 w-4 mr-2"}),"Set Custom Deadline"]})}),e.jsxs(z,{children:[e.jsx(M,{children:e.jsx(B,{children:"Set Assignment Deadline"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Select Assignment"}),e.jsxs(b,{value:P,onValueChange:te,children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Choose assignment"})}),e.jsx(S,{children:h.map(s=>e.jsx(g,{value:s.id,children:s.title},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Select User"}),e.jsxs(b,{value:$,onValueChange:ae,children:[e.jsx(y,{children:e.jsx(C,{placeholder:"Choose user"})}),e.jsx(S,{children:_.map(s=>e.jsx(g,{value:s.id,children:s.full_name||s.email},s.id))})]})]}),e.jsxs("div",{children:[e.jsx(m,{children:"Deadline (local time)"}),e.jsx(d,{type:"datetime-local",value:w,onChange:s=>ie(s.target.value)})]}),e.jsx(r,{onClick:Oe,className:"w-full",children:"Save Deadline"})]})]})]})]}),h.map(s=>{const t=ce().filter(a=>a.assignment_id===s.id);return t.length===0?null:e.jsxs(T,{className:"p-6",children:[e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:s.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.course," (",s.course_code,")"]}),s.due_date&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsxs("span",{children:["Due: ",new Date(s.due_date).toLocaleDateString()]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Total Submissions: ",t.length]})]}),e.jsx("div",{className:"space-y-3",children:t.map(a=>{var n,x;return e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:((n=a.profiles)==null?void 0:n.full_name)||((x=a.profiles)==null?void 0:x.email)||"Unknown User"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Submitted: ",new Date(a.submitted_at).toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Attempts used: ",Ue(s.id,a.user_id)," / ",s.attempts]}),a.marks_obtained!==null&&e.jsxs(p,{className:"mt-2 bg-success/20 text-success",children:[a.marks_obtained," / ",s.points]})]}),e.jsxs(r,{variant:"destructive",size:"sm",onClick:()=>ke(a.id),children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Delete"]})]},a.id)})})]},s.id)}),ce().length===0&&e.jsx(T,{className:"p-8 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:D==="all"?"No submissions yet":"No submissions from this user"})})]}):e.jsxs(Me,{defaultValue:"pending",children:[e.jsxs(Be,{className:"grid w-full max-w-md grid-cols-2",children:[e.jsxs(ge,{value:"pending",children:["Pending (",he.length,")"]}),e.jsxs(ge,{value:"completed",children:["Completed (",xe.length,")"]})]}),e.jsxs(je,{value:"pending",className:"space-y-4 mt-6",children:[j&&e.jsxs(r,{onClick:()=>me("pending"),className:"gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"Add Assignment"]}),he.map(s=>e.jsxs(T,{className:"p-6 border-l-4 border-l-accent hover:shadow-glow transition-all relative group",children:[j&&e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(r,{onClick:()=>ue(s),size:"icon",variant:"ghost",className:"h-8 w-8",children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx(r,{onClick:()=>oe(s.id),size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive",children:e.jsx(J,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-3 flex-1",children:j?e.jsxs(e.Fragment,{children:[e.jsx(d,{value:s.title,onChange:t=>c(s.id,"title",t.target.value),placeholder:"Assignment Title"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsx(d,{value:s.course,onChange:t=>c(s.id,"course",t.target.value),placeholder:"Course"}),e.jsx(d,{value:s.course_code,onChange:t=>c(s.id,"course_code",t.target.value),placeholder:"Code"})]}),e.jsx(pe,{value:s.description||"",onChange:t=>c(s.id,"description",t.target.value),placeholder:"Description",rows:2}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:[e.jsx(d,{type:"date",value:s.due_date||"",onChange:t=>c(s.id,"due_date",t.target.value)}),e.jsx(d,{type:"number",value:s.hours_left||0,onChange:t=>c(s.id,"hours_left",parseInt(t.target.value)),placeholder:"Hours"}),e.jsx(d,{type:"number",value:s.points||0,onChange:t=>c(s.id,"points",parseInt(t.target.value)),placeholder:"Points"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:e.jsxs("div",{children:[e.jsx(m,{className:"text-xs",children:"Attempts Allowed"}),e.jsx(d,{type:"number",min:"1",value:s.attempts||2,onChange:t=>c(s.id,"attempts",parseInt(t.target.value)),placeholder:"Attempts"})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-xl font-semibold",children:s.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.course," (",s.course_code,")"]}),e.jsx("p",{className:"text-sm",children:s.description}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[(s.custom_deadline||s.due_date)&&e.jsxs(p,{variant:"outline",className:"bg-primary/10",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),(()=>{const t=s.custom_deadline||s.due_date,a=re(t);return a?`Due: ${a.toLocaleString()}`:"Due: Invalid date"})()]}),e.jsx(p,{variant:s.priority==="high"?"destructive":"secondary",children:s.priority}),e.jsxs(p,{variant:"outline",children:[s.points," pts"]}),(()=>{const t=Fe(s.custom_deadline||s.due_date);return t===null?null:e.jsxs(p,{variant:"outline",children:[e.jsx(ze,{className:"h-3 w-3 mr-1"}),t,"h left"]})})(),e.jsxs(p,{variant:"outline",children:[s.attempts," attempt(s) allowed"]})]}),A(s.id)?e.jsxs("div",{className:"mt-2 p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium",children:"Submitted"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Awaiting grading"})]}):e.jsxs(e.Fragment,{children:[e.jsx("input",{id:`submit-${s.id}`,type:"file",className:"hidden",onChange:a=>{var x;const n=(x=a.target.files)==null?void 0:x[0];n&&($e(s.id,n),a.target.value="")}}),e.jsxs(r,{className:"w-full bg-gradient-primary mt-2",onClick:()=>{var a;return(a=document.getElementById(`submit-${s.id}`))==null?void 0:a.click()},disabled:!!le,children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),le===s.id?"Submitting...":"Submit"]})]})]})})]},s.id))]}),e.jsxs(je,{value:"completed",className:"space-y-4 mt-6",children:[j&&e.jsxs(r,{onClick:()=>me("completed"),className:"gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"Add Completed"]}),xe.map(s=>e.jsxs(T,{className:"p-6 border-l-4 border-l-success hover:shadow-glow transition-all relative group",children:[j&&e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(r,{onClick:()=>ue(s),size:"icon",variant:"ghost",className:"h-8 w-8",children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx(r,{onClick:()=>oe(s.id),size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive",children:e.jsx(J,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-3",children:j?e.jsxs(e.Fragment,{children:[e.jsx(d,{value:s.title,onChange:t=>c(s.id,"title",t.target.value),placeholder:"Title"}),e.jsx(d,{value:s.grade||"",onChange:t=>c(s.id,"grade",t.target.value),placeholder:"Grade"}),e.jsx(pe,{value:s.feedback||"",onChange:t=>c(s.id,"feedback",t.target.value),placeholder:"Feedback",rows:2})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold",children:s.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.course," (",s.course_code,")"]})]}),(()=>{const t=A(s.id);return(t==null?void 0:t.marks_obtained)!==null?e.jsxs(p,{className:"bg-success/20 text-success",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),t.marks_obtained," / ",s.points]}):null})()]}),(()=>{const t=A(s.id);return t!=null&&t.feedback?e.jsxs("div",{className:"bg-muted/30 p-3 rounded",children:[e.jsx("p",{className:"text-sm font-medium mb-1",children:"Feedback:"}),e.jsx("p",{className:"text-sm",children:t.feedback})]}):null})()]})})]},s.id))]})]})]})}export{ss as default};
